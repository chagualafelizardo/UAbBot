<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>UAbBot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --accent: #007bff;
      --history-width: 260px;
      --header-height: 60px;
      --history-item-hover: rgba(255,255,255,0.05);
      --danger: #dc3545;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; background: #f7f7f8; }
    
    /* HEADER */
    header { 
      background: #202123; 
      color: white; 
      height: var(--header-height);
      display: flex; 
      align-items: center; 
      padding: 0 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: relative;
      z-index: 10;
    }
    
    .header-title {
      font-size: 1.2rem;
      font-weight: 500;
      margin-left: 10px;
    }
    
    .header-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
    }
    
    .header-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .header-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    
    /* MAIN CONTAINER */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    /* HISTORY (left) */
    .history-panel { 
      width: var(--history-width); 
      background: #202123;
      color: white;
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(255,255,255,0.1);
      transition: transform 0.3s ease;
      height: calc(100vh - var(--header-height));
      position: relative;
    }
    
    .history-header { 
      padding: 15px; 
      border-bottom: 1px solid rgba(255,255,255,0.1); 
      position: sticky;
      top: 0;
      background: #202123;
      z-index: 2;
    }
    
    .new-chat-btn { 
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .new-chat-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .history-search { 
      width: 100%;
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 5px;
      border: none;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 13px;
      transition: background 0.2s;
    }
    
    .history-search:focus {
      background: rgba(255,255,255,0.15);
      outline: none;
    }
    
    .history-search::placeholder {
      color: rgba(255,255,255,0.5);
    }
    
    .history-list { 
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.2) transparent;
    }
    
    .history-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .history-list::-webkit-scrollbar-thumb {
      background-color: rgba(255,255,255,0.2);
      border-radius: 3px;
    }
    
    .history-section {
      margin-bottom: 15px;
    }
    
    .history-section-title {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding: 0 5px;
    }
    
    .conversation-item { 
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 5px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    
    .conversation-item:hover {
      background: var(--history-item-hover);
    }
    
    .conversation-item.active {
      background: rgba(255,255,255,0.2);
    }
    
    .conversation-item-icon {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      opacity: 0.7;
    }
    
    .conversation-content {
      flex: 1;
      min-width: 0;
    }
    
    .conversation-title { 
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }
    
    .conversation-meta { 
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .conversation-meta .time {
      font-size: 10px;
    }
    
    /* CHAT AREA (right) */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: calc(100vh - var(--header-height));
      background: #f7f7f8;
      position: relative;
    }
    
    #chat { 
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scroll-behavior: smooth;
    }
    
    .msg { 
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      line-height: 1.5;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user { 
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      align-self: flex-end;
      max-width: 90%;
    }
    
    .bot { 
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      align-self: flex-start;
      max-width: 90%;
    }
    
    /* INPUT AREA */
    .input-area { 
      padding: 15px;
      background: white;
      border-top: 1px solid #e5e5e6;
      position: sticky;
      bottom: 0;
    }
    
    .input-container {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      position: relative;
    }
    
    #userInput { 
      flex: 1;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #e5e5e6;
      outline: none;
      font-size: 15px;
      resize: none;
      min-height: 50px;
      max-height: 200px;
      transition: border-color 0.2s;
    }
    
    #userInput:focus {
      border-color: var(--accent);
    }
    
    /* BOTTOM BAR */
    .bottom-bar {
      display: flex;
      justify-content: flex-start; /* Alinhado à esquerda */
      background-color: transparent;
      padding: 8px 0 0 0; /* Ajuste do padding */
      gap: 8px;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .action-btn {
      border: none;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      background: rgba(0, 0, 0, 0.05);
      font-size: 13px;
      gap: 6px;
      color: #555;
    }
    
    
    .action-btn:hover {
      background: rgba(0, 0, 0, 0.08);
    }
    
    .action-btn svg {
      width: 16px;
      height: 16px;
      stroke-width: 2;
    }
    
    /* Estilo para o botão de enviar/parar */
    #sendBtn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    #sendBtn:hover {
      background: #0069d9;
    }

    #sendBtn:active {
      transform: scale(0.95);
    }

    /* Remove a cor vermelha do estado sending */
    #sendBtn.sending {
      background: var(--accent); /* Mantém azul */
    }

    #stopIcon {
      display: none;
    }

    #sendBtn.sending #sendIcon {
      display: none;
    }

    #sendBtn.sending #stopIcon {
      display: block;
    }
    
    /* EMOJI PICKER */
    #emojiPicker {
      display: none;
      flex-wrap: wrap;
      padding: 10px;
      background: white;
      border-top: 1px solid #e5e5e6;
      max-height: 150px;
      overflow-y: auto;
      gap: 5px;
    }
    
    #emojiPicker span {
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    #emojiPicker span:hover {
      transform: scale(1.2);
    }
    
    /* TYPING INDICATOR */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: 0 auto 20px;
      width: 100%;
      animation: fadeIn 0.3s ease;
    }
    
    .typing-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e5e5e6;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #003366;
    }
    
    .typing-dots {
      display: flex;
      gap: 5px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: #666;
      border-radius: 50%;
      opacity: 0.4;
      animation: bounce 1.2s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); opacity: 0.4; }
      50% { transform: translateY(-5px); opacity: 0.8; }
    }
    
    /* MENU OPTIONS */
    .menu-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }
    
    .menu-btn {
      background: rgba(0,123,255,0.1);
      border: 1px solid rgba(0,123,255,0.2);
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .menu-btn:hover {
      background: rgba(0,123,255,0.2);
    }
    
    /* COURSE BUBBLES */
    .course-bubble {
      margin: 8px 0;
      padding: 10px;
      background-color: #e9f5ff;
      border-radius: 12px;
      border: 1px solid #d0e3ff;
    }
    
    .course-title {
      font-weight: bold;
      margin-bottom: 6px;
    }
    
    /* MOBILE RESPONSIVE */
    @media (max-width: 768px) {
      .history-panel {
        position: fixed;
        top: var(--header-height);
        left: 0;
        bottom: 0;
        z-index: 100;
        transform: translateX(-100%);
        width: 85%;
        max-width: 300px;
      }
      
      .history-panel.active {
        transform: translateX(0);
        box-shadow: 2px 0 10px rgba(0,0,0,0.2);
      }
      
      .menu-toggle {
        display: block;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        margin-right: 15px;
      }
      
      .overlay {
        position: fixed;
        top: var(--header-height);
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 99;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      
      .overlay.active {
        opacity: 1;
        pointer-events: all;
      }
    }
    
    /* UTILITY CLASSES */
    .hidden {
      display: none !important;
    }
    
    .empty-state {
      padding: 20px;
      color: rgba(255,255,255,0.5);
      text-align: center;
      font-size: 14px;
    }

    /* Dropdown styles */
    .message-options {
      position: absolute;
      top: 5px;
      right: 5px;
      display: inline-block;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .msg {
      position: relative;
    }

    .msg:hover .message-options {
      opacity: 1;
    }

    .options-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .options-btn:hover {
      background: rgba(0,0,0,0.1);
    }

    .options-dropdown {
      position: absolute;
      right: 0;
      top: 100%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 100;
      min-width: 160px;
      overflow: hidden;
      display: none;
    }

    .options-dropdown.show {
      display: block;
    }

    .option-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .option-item:hover {
      background: #f5f5f5;
    }

    .option-item svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .option-item.delete {
      color: var(--danger);
    }

    /* History item options */
    .history-panel .message-options {
      opacity: 0;
      transition: opacity 0.2s;
    }

    .history-panel .conversation-item:hover .message-options {
      opacity: 1;
    }

    .history-panel .options-dropdown {
      background: #343541;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .history-panel .option-item {
      color: #ececf1;
    }

    .history-panel .option-item:hover {
      background: #40414f;
    }

    .history-panel .option-item.delete {
      color: #ef4444;
    }

     /* MENSAGENS DO USUÁRIO */
    .user { 
      background: #007bff; /* Azul UAb */
      color: white;
      padding: 15px;
      border-radius: 12px 12px 0 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      align-self: flex-end;
      max-width: 90%;
      margin-left: 10%;
      position: relative;
    }

    /* MENSAGENS DO BOT */
    .bot { 
      background: #f0f0f0; /* Cinza claro */
      color: #333;
      padding: 15px;
      border-radius: 12px 12px 12px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      align-self: flex-start;
      max-width: 90%;
      margin-right: 10%;
      position: relative;
    }

    /* ÍCONE DE USUÁRIO */
    .user::before {
      content: "";
      position: absolute;
      right: -10px;
      top: 0;
      width: 0;
      height: 0;
      border-left: 10px solid #007bff;
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
    }

    /* ÍCONE DO BOT */
    .bot::before {
      content: "";
      position: absolute;
      left: -10px;
      top: 0;
      width: 0;
      height: 0;
      border-right: 10px solid #f0f0f0;
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
    }

    /* OPÇÕES DE MENSAGEM - CORES DIFERENTES */
    .user .options-btn {
      color: rgba(255,255,255,0.8);
    }

    .user .options-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .bot .options-btn {
      color: rgba(0,0,0,0.6);
    }

    .bot .options-btn:hover {
      background: rgba(0,0,0,0.1);
    }

    .msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .user .msg-avatar {
      background: #e3f2fd;
      color: #007bff;
    }

    .bot .msg-avatar {
      background: #f5f5f5;
      color: #666;
    }

    /* OPÇÕES DE MENSAGEM - USUÁRIO (AZUL) */
    .user .options-btn {
      color: rgba(255,255,255,0.8);
    }

    .user .options-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .user .options-dropdown {
      background: #2c3e50;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .user .option-item {
      color: #ecf0f1;
    }

    .user .option-item:hover {
      background: #34495e;
    }

    .user .option-item.delete {
      color: #e74c3c;
    }

    /* OPÇÕES DE MENSAGEM - BOT (CINZA) */
    .bot .options-btn {
      color: rgba(0,0,0,0.6);
    }

    .bot .options-btn:hover {
      background: rgba(0,0,0,0.1);
    }

    .bot .options-dropdown {
      background: #34495e;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .bot .option-item {
      color: #ecf0f1;
    }

    .bot .option-item:hover {
      background: #2c3e50;
    }

    .bot .option-item.delete {
      color: #e74c3c;
    }

    /* MELHORAR VISIBILIDADE DO ÍCONE DE OPÇÕES */
    .message-options {
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .msg:hover .message-options {
      opacity: 1;
    }

    /* ESTILO BASE DAS OPÇÕES */
    #sendBtn {
      background: var(--accent); /* Azul */
      color: white;
      border: none;
      border-radius: 8px;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    #sendBtn:hover {
      background: #0069d9; /* Azul mais escuro no hover */
    }

    /* Mantemos o fundo azul mesmo no estado "sending" */
    #sendBtn.sending {
      background: var(--accent);
    }

    /* Esconde/mostra os ícones conforme o estado */
    #stopIcon {
      display: none;
    }

    #sendBtn.sending #sendIcon {
      display: none;
    }

    #sendBtn.sending #stopIcon {
      display: block;
    }

    .message-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    
    /* Adicione estes novos estilos para os botões */
    .message-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .message-button {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background: #f5f5f5;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .message-button:hover {
      background: #e0e0e0;
    }

    /* Estilo específico para botões de feedback */
    .feedback-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .feedback-button {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .feedback-button:hover {
      background: #f5f5f5;
    }

    /* Estilo para botões em mensagens do bot */
    .bot .message-button,
    .bot .feedback-button {
      background: #f0f0f0;
      border-color: #e0e0e0;
    }

    .bot .message-button:hover,
    .bot .feedback-button:hover {
      background: #e0e0e0;
    }

  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <button class="menu-toggle">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M3 12H21M3 6H21M3 18H21" stroke-width="2"/>
      </svg>
    </button>
    <h1 class="header-title">UAbBot</h1>
  </header>

  <!-- MAIN CONTAINER -->
  <div class="main-container">
    <!-- OVERLAY (mobile only) -->
    <div class="overlay"></div>
    
    <!-- HISTORY PANEL -->
    <aside class="history-panel">
      <div class="history-header">
        <button id="newChatButton" class="new-chat-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 4V20M4 12H20" stroke-width="2"/>
          </svg>
          Nova conversa
        </button>
        <input id="historySearch" class="history-search" placeholder="Pesquisar conversas..."/>
      </div>
      <div id="historyList" class="history-list"></div>
    </aside>

    <!-- CHAT AREA -->
    <div class="chat-area">
      <div id="chat"></div>
      
      <!-- INPUT AREA -->
      <div class="input-area">
        <div class="input-container">
          <textarea id="userInput" placeholder="Digite sua mensagem..." rows="1"></textarea>
            <button id="sendBtn">
              <!-- Ícone de Enviar (seta) -->
              <svg id="sendIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
              </svg>
              
              <!-- Ícone de Parar (retângulo branco centralizado) -->
              <svg id="stopIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" style="display: none;">
                <rect x="6" y="6" width="12" height="12" fill="white" rx="1"/>
              </svg>
            </button>
        </div>
        
        <!-- BOTTOM BAR WITH ACTIONS - NOVO DESIGN -->
        <div class="bottom-bar">
          <button id="emojiBtn" class="action-btn" title="Inserir emoji">
            😊
          </button>
          <button id="clearBtn" class="action-btn" title="Limpar conversa">
            🧹
          </button>
          <button id="languageToggle" class="action-btn" title="Mudar idioma">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
            </svg>
            <span id="languageText">PT</span>
          </button>
        </div>
        
        <!-- EMOJI PICKER -->
        <div id="emojiPicker"></div>
      </div>
      
      </div>
    </div>
  </div>

<script>
/* ---------- Storage & Convos ---------- */
const STORAGE_KEY = 'uabbot_conversations_v3';
function uid(){ return 'c_' + Date.now() + '_' + Math.random().toString(36).slice(2,8); }

let conversations = {};
let currentConversationId = null;
let isSending = false;
let abortController = null;

function loadConversationsFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return {};
    return JSON.parse(raw) || {};
  } catch(e){ console.error('Erro ao ler storage', e); return {}; }
}

function saveConversationsToStorage(){ 
  try { 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations)); 
  } catch(e){ 
    console.error('Erro ao salvar storage', e); 
  } 
}

function createNewConversation(title = 'Nova conversa'){
  const id = uid();
  const conv = { 
    id, 
    title, 
    messages: [], 
    updatedAt: Date.now(),
    createdAt: Date.now()
  };
  conversations[id] = conv;
  saveConversationsToStorage();
  updateConversationList();
  setCurrentConversation(id);
  return conv;
}

function setCurrentConversation(id){
  currentConversationId = id;
  updateConversationList();
  renderConversation(conversations[id]);
}

// Atualizar a função addMessageToConversation para incluir timestamp
function addMessageToConversation(id, sender, text) {
  if (!conversations[id]) return;
  
  const msg = { 
    sender, 
    text, 
    ts: Date.now() // Garantir que cada mensagem tenha um timestamp único
  };
  
  conversations[id].messages.push(msg);
  conversations[id].updatedAt = Date.now();
  
  // Atualizar título se for a primeira mensagem do usuário
  if (sender === 'user' && (conversations[id].title === 'Nova conversa' || !conversations[id].title)) {
    const short = text.length > 45 ? text.slice(0, 45) + '...' : text;
    conversations[id].title = short;
  }
  
  saveConversationsToStorage();
  updateConversationList();
}


/* ---------- Date Formatting ---------- */
function formatConversationDate(timestamp) {
  const now = new Date();
  const date = new Date(timestamp);
  const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) {
    return { dateStr: 'Hoje', timeStr: date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) };
  } else if (diffDays === 1) {
    return { dateStr: 'Ontem', timeStr: date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) };
  } else if (diffDays < 7) {
    const days = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
    return { dateStr: days[date.getDay()], timeStr: date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) };
  } else {
    return { 
      dateStr: date.toLocaleDateString([], { day: '2-digit', month: '2-digit' }), 
      timeStr: date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
    };
  }
}

function groupConversationsByDate(conversations) {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const lastWeek = new Date(today);
  lastWeek.setDate(lastWeek.getDate() - 7);
  
  const groups = {
    hoje: { title: 'Hoje', items: [] },
    ontem: { title: 'Ontem', items: [] },
    estaSemana: { title: 'Esta semana', items: [] },
    anterior: { title: 'Anterior', items: [] }
  };
  
  conversations.forEach(conv => {
    const convDate = new Date(conv.updatedAt);
    
    if (convDate >= today) {
      groups.hoje.items.push(conv);
    } else if (convDate >= yesterday) {
      groups.ontem.items.push(conv);
    } else if (convDate >= lastWeek) {
      groups.estaSemana.items.push(conv);
    } else {
      groups.anterior.items.push(conv);
    }
  });
  
  // Remove empty groups
  return Object.entries(groups)
    .filter(([_, group]) => group.items.length > 0)
    .map(([_, group]) => group);
}

/* ---------- UI: list & render ---------- */
const historyList = document.getElementById('historyList');
const chatEl = document.getElementById('chat');

function escapeHtml(unsafe){
  if (!unsafe && unsafe !== '') return '';
  return String(unsafe)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function updateConversationList(){
  historyList.innerHTML = '';
  const items = Object.values(conversations).sort((a, b) => b.updatedAt - a.updatedAt);
  
  if (items.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.textContent = 'Nenhuma conversa encontrada';
    historyList.appendChild(empty);
    return;
  }
  
  // Group conversations by date
  const grouped = groupConversationsByDate(items);
  
  // Render each group
  grouped.forEach(group => {
    const section = document.createElement('div');
    section.className = 'history-section';
    
    const title = document.createElement('div');
    title.className = 'history-section-title';
    title.textContent = group.title;
    section.appendChild(title);
    
    group.items.forEach(conv => {
      const el = document.createElement('div');
      el.className = 'conversation-item';
      if (conv.id === currentConversationId) {
        el.classList.add('active');
      }
      el.dataset.id = conv.id;
      
      const dateInfo = formatConversationDate(conv.updatedAt);
      
      el.innerHTML = `
        <svg class="conversation-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <div class="conversation-content">
          <div class="conversation-title">${escapeHtml(conv.title)}</div>
          <div class="conversation-meta">
            <span class="date">${dateInfo.dateStr}</span>
            <span>•</span>
            <span class="time">${dateInfo.timeStr}</span>
          </div>
        </div>
      `;
      
      // Add options button
      const optionsDiv = document.createElement('div');
      optionsDiv.className = 'message-options';
      optionsDiv.style.position = 'absolute';
      optionsDiv.style.right = '10px';
      optionsDiv.style.top = '10px';
      
      const optionsBtn = document.createElement('button');
      optionsBtn.className = 'options-btn';
      optionsBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="1" stroke-width="2"/>
          <circle cx="12" cy="5" r="1" stroke-width="2"/>
          <circle cx="12" cy="19" r="1" stroke-width="2"/>
        </svg>
      `;
      
      const dropdown = document.createElement('div');
      dropdown.className = 'options-dropdown';
      dropdown.style.right = '0';
      dropdown.style.top = '100%';
      
      // Add dropdown options
      const renameOption = createOptionItem('Renomear', 'rename');
      const shareOption = createOptionItem('Partilhar', 'share');
      const archiveOption = createOptionItem('Arquivar', 'archive');
      const deleteOption = createOptionItem('Apagar', 'delete', true);
      
      // Add event listeners
      optionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('show');
      });
      
      // Add options to dropdown
      dropdown.appendChild(renameOption);
      dropdown.appendChild(shareOption);
      dropdown.appendChild(archiveOption);
      dropdown.appendChild(deleteOption);
      
      // Add event handlers for each option
      renameOption.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.remove('show');
        const newTitle = prompt('Novo nome para a conversa:', conv.title);
        if (newTitle && newTitle.trim()) {
          conv.title = newTitle.trim();
          conv.updatedAt = Date.now();
          saveConversationsToStorage();
          updateConversationList();
        }
      });
      
      shareOption.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.remove('show');
        const shareText = `Conversa: ${conv.title}\n\n${conv.messages.slice(0, 3).map(m => `${m.sender === 'user' ? 'Você' : 'UAbBot'}: ${m.text}`).join('\n')}${conv.messages.length > 3 ? '\n...' : ''}`;
        if (navigator.share) {
          navigator.share({
            title: 'Partilhar conversa',
            text: shareText
          }).catch(err => console.log('Erro ao partilhar:', err));
        } else {
          prompt('Copie o texto para partilhar:', shareText);
        }
      });
      
      archiveOption.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.remove('show');
        conv.archived = true;
        conv.updatedAt = Date.now();
        saveConversationsToStorage();
        updateConversationList();
      });
      
      deleteOption.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.remove('show');
        if (confirm('Tem certeza que deseja apagar esta conversa?')) {
          delete conversations[conv.id];
          saveConversationsToStorage();
          
          // If we're deleting the current conversation, create a new one
          if (currentConversationId === conv.id) {
            const newConv = createNewConversation();
            setCurrentConversation(newConv.id);
          } else {
            updateConversationList();
          }
        }
      });
      
      optionsDiv.appendChild(optionsBtn);
      optionsDiv.appendChild(dropdown);
      el.appendChild(optionsDiv);
      
      el.addEventListener('click', (e) => {
        // Don't change conversation if clicking on options
        if (!optionsDiv.contains(e.target)) {
          setCurrentConversation(conv.id);
          if (window.innerWidth <= 768) {
            document.querySelector('.history-panel').classList.remove('active');
            document.querySelector('.overlay').classList.remove('active');
          }
        }
      });
      
      section.appendChild(el);
    });
    
    historyList.appendChild(section);
  });
}

// Helper function to create option items
// Função auxiliar para criar itens de opção (reutilizada)
function createOptionItem(text, icon, isDelete = false) {
  const option = document.createElement('div');
  option.className = `option-item ${isDelete ? 'delete' : ''}`;
  
  let iconSvg = '';
  switch(icon) {
    case 'rename':
      iconSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
      break;
    case 'share':
      iconSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="18" cy="5" r="3" stroke-width="2"/><circle cx="6" cy="12" r="3" stroke-width="2"/><circle cx="18" cy="19" r="3" stroke-width="2"/><path d="M8.59 13.51l6.83 3.98" stroke-width="2"/><path d="M15.41 6.51l-6.82 3.98" stroke-width="2"/></svg>`;
      break;
    case 'delete':
      iconSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke-width="2"/></svg>`;
      break;
  }
  
  option.innerHTML = `${iconSvg}${text}`;
  return option;
}

function renderConversation(conv){
  chatEl.innerHTML = '';
  if (!conv) return;
  
  conv.messages.forEach(m => {
    const div = createMessageElement(m.sender, m.text, m.ts);
    chatEl.appendChild(div);
  });
  
  // Scroll to bottom
  chatEl.scrollTop = chatEl.scrollHeight;
}

// Função para criar elementos de mensagem com opções completas
/* ---------- Create Message with Buttons ---------- */
function createMessageElement(sender, text, messageId = null, metadata = {}) {
  const d = document.createElement('div');
  d.className = 'msg ' + (sender === 'user' ? 'user' : 'bot');
  
  // Main container
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.gap = '10px';
  container.style.alignItems = 'flex-end';
  container.style.flexDirection = sender === 'user' ? 'row-reverse' : 'row';

  // Avatar
  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  avatar.innerHTML = sender === 'user' ? 
    '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>' :
    '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><circle cx="12" cy="6" r="1"></circle><line x1="8" y1="12" x2="16" y2="12"></line><line x1="8" y1="16" x2="16" y2="16"></line></svg>';
  
  // Content container
  const content = document.createElement('div');
  content.style.position = 'relative';
  content.style.maxWidth = 'calc(100% - 50px)';
  
  // Message text
  const textEl = document.createElement('div');
  textEl.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
  content.appendChild(textEl);

  // Add buttons if they exist in metadata
  if (metadata.buttons && metadata.buttons.length > 0) {
    console.log('Creating buttons with data:', metadata.buttons); // Debug
    
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'message-buttons';
    
    metadata.buttons.forEach(btn => {
      const button = document.createElement('button');
      button.className = 'message-button';
      button.textContent = btn.title;
      
      button.addEventListener('click', () => {
        console.log('Button clicked:', btn.payload); // Debug
        userInput.value = btn.payload;
        handleSendMessage();
      });

      buttonsContainer.appendChild(button);
    });

    content.appendChild(buttonsContainer);
  }
  
  // Add message to chat
  container.appendChild(avatar);
  container.appendChild(content);
  d.appendChild(container);
  
  return d;
}

/* ---------- Init convs ---------- */
conversations = loadConversationsFromStorage();
if (!conversations || Object.keys(conversations).length === 0) {
  createNewConversation();
} else {
  const newest = Object.values(conversations).sort((a, b) => b.updatedAt - a.updatedAt)[0];
  setCurrentConversation(newest.id);
}

/* ---------- Message queue, typewriter, append ---------- */
let messageQueue = [];
let isProcessingQueue = false;
let typingIndicator = null;
let isTyping = false;
let isTypingActive = true; // Controla se a digitação deve continuar
let currentTypingWriter = null; // Referência à função de digitação atual

// Atualizar a função processMessageQueue para passar o messageId
function processMessageQueue(){
  if (isProcessingQueue || messageQueue.length === 0) return;
  isProcessingQueue = true;
  
  const { message, metadata, resolve } = messageQueue.shift();
  const msgEl = document.createElement('div');
  msgEl.className = 'msg bot';
  chatEl.appendChild(msgEl);
  
  const typingSpeed = metadata?.type_speed || 20;
  let i = 0;
  
  function writer(){
    if (i < message.length) {
      msgEl.innerHTML = escapeHtml(message.substring(0, i + 1)).replace(/\n/g, '<br>');
      i++;
      setTimeout(writer, typingSpeed);
    } else {
      // Adicionar opções à mensagem após terminar de digitar
      const optionsDiv = createMessageElement('bot', message, metadata.messageId)
        .querySelector('.message-options');
      msgEl.appendChild(optionsDiv.cloneNode(true));
      
      resolve();
      setTimeout(() => { 
        isProcessingQueue = false; 
        processMessageQueue(); 
      }, metadata?.typing_delay || 300);
    }
    chatEl.scrollTop = chatEl.scrollHeight;
  }
  
  writer();
}

// Atualizar a função appendMessage para garantir que as opções sejam adicionadas
// Função atualizada para adicionar mensagens com suporte a botões
function appendMessage(sender, text, options = null, metadata = {}) {
  return new Promise((resolve) => {
    const messageId = metadata.messageId || Date.now();
    const msgElement = createMessageElement(sender, text, messageId, metadata);
    chatEl.appendChild(msgElement);
    
    // Resetar o estado de digitação
    isTypingActive = true;
    
    if (sender === 'bot' && metadata.type_speed) {
      const typingSpeed = metadata.type_speed;
      let i = 0;
      const textEl = msgElement.querySelector('div > div:first-child');
      textEl.innerHTML = '';
      
      currentTypingWriter = function writer() {
        if (!isTypingActive) {
          textEl.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
          currentTypingWriter = null;
          resolve();
          return;
        }
        
        if (i < text.length) {
          textEl.innerHTML = escapeHtml(text.substring(0, i + 1)).replace(/\n/g, '<br>');
          i++;
          setTimeout(writer, typingSpeed);
        } else {
          currentTypingWriter = null;
          resolve();
        }
        chatEl.scrollTop = chatEl.scrollHeight;
      };
      
      currentTypingWriter();
    } else {
      resolve();
    }
  });
}

/* ---------- Typing indicator ---------- */
function showTyping(){
  if (isTyping) return;
  isTyping = true;
  
  // Remove existing typing indicator if any
  if (typingIndicator && typingIndicator.parentNode) {
    typingIndicator.parentNode.removeChild(typingIndicator);
  }
  
  typingIndicator = document.createElement('div');
  typingIndicator.className = 'typing-indicator';
  
  typingIndicator.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <div class="typing-avatar">
        <img src="static/images/uab_logo.png" alt="UAb" style="width: 32px; height: 32px; border-radius: 50%;">
      </div>
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
  `;

  chatEl.appendChild(typingIndicator);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function hideTyping(){
  if (!isTyping) return;
  isTyping = false;
  
  if (typingIndicator && typingIndicator.parentNode) {
    typingIndicator.parentNode.removeChild(typingIndicator);
  }
  typingIndicator = null;
}

/* ---------- Welcome message and menus ---------- */
function showWelcomeMessage(){
  const welcomeMsg = document.createElement('div');
  welcomeMsg.className = 'msg bot';
  chatEl.appendChild(welcomeMsg);

  const welcomeText = `Olá! Eu sou o UAbBot, o seu assistente virtual. Como posso ajudar você hoje? 👋\nO que deseja saber?`;
  const menuOptions = [
    { title: "1. Admissão", payload: "admission_info" },
    { title: "2. Matrículas", payload: "enrollment_info" },
    { title: "3. Propinas", payload: "tuition_info" },
    { title: "4. Apoio Académico", payload: "academic_support" },
    { title: "5. Cursos", payload: "ask_uab_courses" },
    { title: "6. Bolsas", payload: "scholarship_info" },
    { title: "7. Investigação", payload: "research_info" }
  ];

  let i = 0;
  const textSpeed = 30;
  
  function typeWriterText(){
    if (i < welcomeText.length){
      welcomeMsg.innerHTML = welcomeText.substring(0, i + 1).replace(/\n/g, '<br>');
      i++;
      setTimeout(typeWriterText, textSpeed);
    } else {
      const menuContainer = document.createElement('div');
      menuContainer.className = 'menu-options';
      welcomeMsg.appendChild(menuContainer);

      let j = 0;
      const buttonSpeed = 500;

      function typeWriterButtons(){
        if (j < menuOptions.length){
          const btn = document.createElement('button');
          btn.className = 'menu-btn';
          btn.textContent = menuOptions[j].title;
          btn.style.opacity = '0';
          btn.style.transition = 'opacity 0.3s ease';

          const currentPayload = menuOptions[j].payload;

          btn.addEventListener('click', () => {
            showTyping();
            if (currentPayload === 'ask_uab_courses'){
              setTimeout(() => { 
                hideTyping(); 
                showCourseTypesMenu(); 
              }, 800);
            } else {
              fetch("http://localhost:5005/webhooks/rest/webhook", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                body: JSON.stringify({ 
                  sender: "user_" + Date.now(), 
                  message: currentPayload, 
                  metadata: { language: currentLanguage } 
                })
              })
              .then(r => r.json())
              .then(data => {
                hideTyping();
                if (data && data.length > 0){
                  data.forEach(response => {
                    if (response.text) {
                      appendMessage('bot', response.text)
                        .then(() => addMessageToConversation(currentConversationId, 'bot', response.text));
                    }
                  });
                }
              })
              .catch(err => { 
                hideTyping(); 
                console.error('Erro:', err); 
                appendMessage('bot', 'Erro ao contactar servidor.')
                  .then(() => addMessageToConversation(currentConversationId, 'bot', 'Erro ao contactar servidor.')); 
              });
            }
          });

          menuContainer.appendChild(btn);
          setTimeout(() => { btn.style.opacity = '1'; }, 10);
          j++;
          setTimeout(typeWriterButtons, buttonSpeed);
        }
      }
      
      typeWriterButtons();
    }
    chatEl.scrollTop = chatEl.scrollHeight;
  }
  
  typeWriterText();
}

function showCourseTypesMenu(){
  const courseTypesMsg = document.createElement('div');
  courseTypesMsg.className = 'msg bot';
  chatEl.appendChild(courseTypesMsg);

  const questionText = "Que tipo de curso deseja consultar?";
  const menuOptions = [
    { title: "1. Licenciaturas", payload: "licenciatura" },
    { title: "2. Mestrados", payload: "mestrado" },
    { title: "3. Doutoramentos", payload: "doutoramento" }
  ];

  let i = 0;
  const textSpeed = 30;
  
  function typeWriterQuestion(){
    if (i < questionText.length){
      courseTypesMsg.innerHTML = questionText.substring(0, i + 1);
      i++;
      setTimeout(typeWriterQuestion, textSpeed);
    } else {
      const menuContainer = document.createElement('div');
      menuContainer.className = 'menu-options';
      courseTypesMsg.appendChild(menuContainer);

      let j = 0;
      const buttonSpeed = 500;

      function typeWriterButtons(){
        if (j < menuOptions.length){
          const btn = document.createElement('button');
          btn.className = 'menu-btn';
          btn.textContent = menuOptions[j].title;
          btn.style.opacity = '0';
          btn.style.transition = 'opacity 0.3s ease';

          const currentPayload = menuOptions[j].payload;
          
          btn.addEventListener('click', () => {
            showTyping();
            fetch("http://localhost:5005/webhooks/rest/webhook", {
              method: "POST",
              headers: { "Content-Type": "application/json", "Accept": "application/json" },
              body: JSON.stringify({ 
                sender: "user_" + Date.now(), 
                message: currentPayload, 
                metadata: { language: currentLanguage } 
              })
            })
            .then(r => r.json())
            .then(data => {
              hideTyping();
              if (data && data.length > 0){
                data.forEach(response => {
                  if (response.text) {
                    appendMessage('bot', response.text)
                      .then(() => addMessageToConversation(currentConversationId, 'bot', response.text));
                  }
                });
              }
            })
            .catch(err => { 
              hideTyping(); 
              console.error('Erro:', err); 
              appendMessage('bot', 'Erro ao contactar servidor.')
                .then(() => addMessageToConversation(currentConversationId, 'bot', 'Erro ao contactar servidor.')); 
            });
          });

          menuContainer.appendChild(btn);
          setTimeout(() => { btn.style.opacity = '1'; }, 10);
          j++;
          setTimeout(typeWriterButtons, buttonSpeed);
        }
      }
      
      typeWriterButtons();
    }
    chatEl.scrollTop = chatEl.scrollHeight;
  }
  
  typeWriterQuestion();
}

/* ---------- Rasa fetch ---------- */
const userInput = document.getElementById('userInput');
let currentLanguage = 'pt';

async function sendMessageToRasa(userMessage){
  try {
    const resp = await fetch("http://localhost:5005/webhooks/rest/webhook", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ 
        sender: "user_" + Date.now(), 
        message: userMessage, 
        metadata: { language: currentLanguage } 
      })
    });
    return await resp.json();
  } catch(e) {
    console.error('Erro Rasa', e);
    return [{ text: 'Erro: não foi possível contactar o servidor.' }];
  }
}

/* ---------- Handle send message ---------- */
// Modifique a função handleSendMessage para suportar abort
async function handleSendMessage() {
  if (isSending) {
    stopSending();
    return;
  }

  const text = userInput.value.trim();
  if (!text) return;
  
  isSending = true;
  isTypingActive = true;
  sendBtn.classList.add('sending');
  
  const messageId = Date.now();
  await appendMessage('user', text, null, { messageId });
  addMessageToConversation(currentConversationId, 'user', text);
  userInput.value = '';
  userInput.style.height = 'auto';
  
  showTyping();
  abortController = new AbortController();
  
  try {
    const resp = await fetch("http://localhost:5005/webhooks/rest/webhook", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ 
        sender: "user_" + Date.now(), 
        message: text, 
        metadata: { language: currentLanguage } 
      }),
      signal: abortController.signal
    });
    
    if (!isSending) return;
    
    const responses = await resp.json();
    hideTyping();
    
    console.log('Full Rasa response:', responses); // Debug
    
    if (responses && responses.length > 0) {
      for (const r of responses) {
        if (!isSending) break;
        
        // Debug: Log each response part
        console.log('Processing response part:', r);
        
        // Handle different response formats
        if (r.text) {
          await processBotResponse(r.text, r.metadata || {});
        }
        
        if (r.custom) {
          // Handle custom payload (buttons)
          if (Array.isArray(r.custom)) {
            for (const part of r.custom) {
              await processBotResponse(part.text, part.metadata || {});
            }
          } else if (r.custom.metadata) {
            await processBotResponse(r.text || '', r.custom.metadata);
          }
        }
      }
    } else if (isSending) {
      await appendMessage('bot', 'Desculpe, não obtive resposta do servidor.', null, {
        messageId: Date.now()
      });
    }
  } catch (e) {
    console.error('Error:', e);
    if (isSending) {
      hideTyping();
      await appendMessage('bot', 'Erro: não foi possível contactar o servidor.', null, {
        messageId: Date.now()
      });
    }
  } finally {
    if (isSending) {
      isSending = false;
      sendBtn.classList.remove('sending');
    }
    abortController = null;
  }
}

// Helper function to process bot responses
async function processBotResponse(text, metadata) {
  const messageId = Date.now();
  
  // Debug: log the metadata we're receiving
  console.log('Processing bot response with metadata:', metadata);
  
  await appendMessage('bot', text, null, {
    ...metadata,
    messageId,
    type_speed: metadata.type_speed || 20
  });
  
  addMessageToConversation(currentConversationId, 'bot', text);
}


// Função para parar o envio e digitação
function stopSending() {
  // Interrompe a requisição HTTP se estiver em andamento
  if (abortController) {
    abortController.abort();
  }
  
  // Interrompe a animação de digitação
  isTypingActive = false;
  
  // Força parar a digitação atual imediatamente
  if (currentTypingWriter) {
    currentTypingWriter = null;
  }
  
  // Atualiza o estado do botão
  isSending = false;
  sendBtn.classList.remove('sending');
  
  // Esconde o indicador de digitação
  hideTyping();
  
  // Mostra mensagem de interrupção
  appendMessage('bot', 'Resposta interrompida.', null, {
    messageId: Date.now(),
    type_speed: 0 // Sem animação de digitação
  }).then(() => {
    addMessageToConversation(currentConversationId, 'bot', 'Resposta interrompida.');
  });
}

/* ---------- UI Events ---------- */
const newChatButton = document.getElementById('newChatButton');
const historySearch = document.getElementById('historySearch');
const sendBtn = document.getElementById('sendBtn');
const menuToggle = document.querySelector('.menu-toggle');
const overlay = document.querySelector('.overlay');
const emojiBtn = document.getElementById('emojiBtn');
const emojiPicker = document.getElementById('emojiPicker');
const clearBtn = document.getElementById('clearBtn');
const clearChatBtn = document.getElementById('clearChatBtn');
const languageToggle = document.getElementById('languageToggle');

// Emoji list
const emojis = [
  "😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇",
  "🙂","🙃","😉","😍","🥰","😘","😗","😙","😚","😋",
  "😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳",
  "😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖",
  "😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯",
  "😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔",
  "🤭","🤫","🤥","😶","😐","😑","😬","🙄","😯","😦",
  "😧","😮","😲","🥱","😴","🤤","😪","😵","🤐","🥴",
  "🤢","🤮","🤧","😷","🤒","🤕","🤑","🤠","😈","👿",
  "👹","👺","🤡","💩","👻","💀","☠️","👽","👾","🤖",
  "🎃","😺","😸","😹","😻","😼","😽","🙀","😿","😾"
];

// Initialize emoji picker
function initEmojiPicker() {
  emojis.forEach(emoji => {
    const span = document.createElement('span');
    span.textContent = emoji;
    span.addEventListener('click', () => {
      userInput.value += emoji;
      userInput.focus();
      emojiPicker.style.display = 'none';
    });
    emojiPicker.appendChild(span);
  });
}

// Toggle emoji picker
function toggleEmojiPicker() {
  if (emojiPicker.children.length === 0) {
    initEmojiPicker();
  }
  emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'flex' : 'none';
}

// Clear current chat
function clearCurrentChat() {
  if (currentConversationId && conversations[currentConversationId]) {
    conversations[currentConversationId].messages = [];
    conversations[currentConversationId].title = 'Nova conversa';
    conversations[currentConversationId].updatedAt = Date.now();
    saveConversationsToStorage();
    updateConversationList();
    renderConversation(conversations[currentConversationId]);
  }
  
  // Show welcome message again
  showTyping();
  setTimeout(() => {
    hideTyping();
    showWelcomeMessage();
  }, 600);
}

// Toggle language
function toggleLanguage() {
  currentLanguage = currentLanguage === 'en' ? 'pt' : 'en';
  languageToggle.textContent = currentLanguage.toUpperCase();
  languageToggle.innerHTML = currentLanguage === 'en' ? 
    `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
    </svg> EN` : 
    `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
    </svg> PT`;
  
  userInput.placeholder = currentLanguage === 'en' ? 'Type your message...' : 'Digite sua mensagem...';
  
  // Send language change message
  const langMsg = currentLanguage === 'en' ? 'Language changed to English' : 'Idioma alterado para Português';
  appendMessage('bot', langMsg)
    .then(() => addMessageToConversation(currentConversationId, 'bot', langMsg));
}

// Auto-resize textarea
userInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});

// Send message on Enter (but allow Shift+Enter for new lines)
userInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    handleSendMessage();
  }
});

// New conversation
newChatButton.addEventListener('click', () => {
  const conv = createNewConversation();
  setCurrentConversation(conv.id);
  
  // Show welcome message
  showTyping();
  setTimeout(() => {
    hideTyping();
    showWelcomeMessage();
  }, 600);
});

// Search conversations
historySearch.addEventListener('input', e => {
  const q = e.target.value.trim().toLowerCase();
  const filtered = Object.values(conversations).filter(c => {
    return (c.title && c.title.toLowerCase().includes(q)) || 
           (c.messages && c.messages.some(m => m.text && m.text.toLowerCase().includes(q)));
  }).sort((a, b) => b.updatedAt - a.updatedAt);
  
  historyList.innerHTML = '';
  
  if (filtered.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'empty-state';
    empty.textContent = 'Nenhuma conversa encontrada';
    historyList.appendChild(empty);
    return;
  }
  
  // Group filtered results by date
  const grouped = groupConversationsByDate(filtered);
  
  // Render each group
  grouped.forEach(group => {
    const section = document.createElement('div');
    section.className = 'history-section';
    
    const title = document.createElement('div');
    title.className = 'history-section-title';
    title.textContent = group.title;
    section.appendChild(title);
    
    group.items.forEach(conv => {
      const el = document.createElement('div');
      el.className = 'conversation-item';
      if (conv.id === currentConversationId) {
        el.classList.add('active');
      }
      el.dataset.id = conv.id;
      
      const dateInfo = formatConversationDate(conv.updatedAt);
      
      el.innerHTML = `
        <svg class="conversation-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <div class="conversation-content">
          <div class="conversation-title">${escapeHtml(conv.title)}</div>
          <div class="conversation-meta">
            <span class="date">${dateInfo.dateStr}</span>
            <span>•</span>
            <span class="time">${dateInfo.timeStr}</span>
          </div>
        </div>
      `;
      
      el.addEventListener('click', () => {
        setCurrentConversation(conv.id);
        if (window.innerWidth <= 768) {
          document.querySelector('.history-panel').classList.remove('active');
          document.querySelector('.overlay').classList.remove('active');
        }
      });
      
      section.appendChild(el);
    });
    
    historyList.appendChild(section);
  });
});

// Send button
sendBtn.addEventListener('click', handleSendMessage);

// Toggle menu on mobile
menuToggle.addEventListener('click', () => {
  document.querySelector('.history-panel').classList.toggle('active');
  document.querySelector('.overlay').classList.toggle('active');
});

// Close menu when clicking overlay
overlay.addEventListener('click', () => {
  document.querySelector('.history-panel').classList.remove('active');
  document.querySelector('.overlay').classList.remove('active');
});

// Emoji button
emojiBtn.addEventListener('click', toggleEmojiPicker);

// Clear button
clearBtn.addEventListener('click', clearCurrentChat);

// Clear chat button in header
clearChatBtn.addEventListener('click', clearCurrentChat);

// Language toggle
languageToggle.addEventListener('click', toggleLanguage);

// Close emoji picker when clicking outside
document.addEventListener('click', (e) => {
  if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
    emojiPicker.style.display = 'none';
  }
});

// Show welcome message on first load
if (Object.keys(conversations).length === 0) {
  setTimeout(() => {
    showTyping();
    setTimeout(() => {
      hideTyping();
      showWelcomeMessage();
    }, 600);
  }, 300);
}
</script>
</body>
</html>